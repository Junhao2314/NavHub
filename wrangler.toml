# ============================================
# NavHub Cloudflare Workers 部署配置
# ============================================
# 此配置用于将 NavHub 部署为 Cloudflare Worker
# 支持自定义域名 + 优选 IP 实现国内加速
# ============================================

name = "navhub"
main = "worker/index.ts"
compatibility_date = "2024-01-01"

# 静态资源目录（Workers Assets，推荐：不占用 KV 指标）
# 说明：
# - 替代 [site]（Workers Sites / __STATIC_CONTENT KV），可显著减少 KV 的读写与存储占用。
# - not_found_handling=single-page-application：用于 SPA 路由回退到 /index.html。
[assets]
directory = "./dist"
binding = "ASSETS"
not_found_handling = "single-page-application"
# 可选：让 /api/* 优先走 Worker（即使同路径存在静态资源）
run_worker_first = ["/api/*"]

# KV 命名空间绑定 (Workers 专用)
# 若需创建新的 KV: wrangler kv:namespace create NAVHUB_WORKER_KV
[[kv_namespaces]]
binding = "NAVHUB_WORKER_KV"
id = "95c81d887bd34118bacadb5aa8ec311a"
# preview_id = ""  # 本地预览时使用的 KV ID (可选)

# R2 Bucket 绑定（可选，推荐：用于存储主同步数据，避免 KV 的 25MB 限制与最终一致性）
# 若需创建新的 R2: wrangler r2 bucket create navhub-sync
# [[r2_buckets]]
# binding = "NAVHUB_WORKER_R2"
# bucket_name = "navhub-sync"

# 环境变量 (也可以在 Cloudflare Dashboard 中设置)
[vars]
# SYNC_PASSWORD = ""  # 同步密码，建议在 Dashboard 中设置而非此处
# SYNC_CORS_ALLOWED_ORIGINS = ""  # 允许的跨域 Origin（逗号分隔；默认仅同源；可设为 "*" 允许任意 Origin，不推荐）
# AI Proxy (可选，默认仅允许 api.openai.com 且仅同源可访问)
# AI_PROXY_ALLOWED_HOSTS = "api.openai.com"  # 允许的上游主机白名单（逗号分隔，支持 *.example.com，可选端口 example.com:443；不支持 * 全放开，避免 SSRF/open-proxy）
# AI_PROXY_ALLOWED_ORIGINS = ""              # 允许的跨域 Origin（逗号分隔，默认仅同源）
# AI_PROXY_ALLOW_INSECURE_HTTP = "false"    # 允许 http 上游（不推荐）

# 生产环境配置 (可选)
# [env.production]
# routes = [
#   { pattern = "your-domain.com/*", zone_name = "your-domain.com" }
# ]

# ============================================
# 部署步骤:
# 1. npm run build
# 2. wrangler kv:namespace create NAVHUB_WORKER_KV
# 3. 将返回的 id 填入上方 kv_namespaces.id
# 4. wrangler deploy
# ============================================
